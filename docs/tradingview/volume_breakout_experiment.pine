//@version=6
strategy(
     "Volume Breakout Experiment – 5m",
     overlay=true,
     initial_capital=1000,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=1,
     commission_value=0.055,
     commission_type=strategy.commission.percent,
     calc_on_every_tick=true)

// Inputs
useSessionFilter = input.bool(false, "Usar filtro sesión")
sessionInput     = input.session("0900-1700", "Sesión (hhmm-hhmm)")

rangeLength      = input.int(30, "Velas rango inicial", minval=5)
rangeOffset      = input.int(2, "Velas offset (excluir)", minval=0)
atrPeriod        = input.int(14, "ATR periodos", minval=1)
minAtr           = input.float(5.0, "ATR mínimo", minval=0.0001, step=0.1)
bufferAtrMult    = input.float(0.2, "ATR x buffer breakout", minval=0.01, step=0.01)
atrMultSL        = input.float(0.8, "ATR x stop", minval=0.1, step=0.1)
atrMultTP        = input.float(1.6, "ATR x take profit", minval=0.1, step=0.1)

volumePeriod     = input.int(20, "Media volumen", minval=1)
volumeMultiplier = input.float(1.5, "Multiplier volume breakout", minval=0.1, step=0.1)

useRsiFilter     = input.bool(true, "Usar filtro RSI")
rsiPeriod        = input.int(14, "RSI periodos", minval=5)
rsiLongMax       = input.float(70, "RSI máximo largos", minval=10, maxval=90)
rsiShortMin      = input.float(30, "RSI mínimo cortos", minval=0, maxval=90)

timeStopBars     = input.int(0, "Time-stop barras (0 = sin)", minval=0)

// Rango y niveles
atrVal     = ta.atr(atrPeriod)
rsiVal     = ta.rsi(close, rsiPeriod)
volMA      = ta.sma(volume, volumePeriod)
rangeHigh  = ta.highest(high[rangeOffset], rangeLength)
rangeLow   = ta.lowest(low[rangeOffset], rangeLength)
longTrig   = rangeHigh + bufferAtrMult * atrVal
shortTrig  = rangeLow  - bufferAtrMult * atrVal

longCross  = ta.crossover(close, longTrig)
shortCross = ta.crossunder(close, shortTrig)
volSpike   = volume > volumeMultiplier * volMA

sessionOK  = not useSessionFilter or not na(time(timeframe.period, sessionInput))
rsiLongOK  = not useRsiFilter or rsiVal <= rsiLongMax
rsiShortOK = not useRsiFilter or rsiVal >= rsiShortMin
atrOK      = atrVal >= minAtr

validLongBreak  = atrOK and sessionOK and rsiLongOK and not na(rangeHigh) and longCross and volSpike
validShortBreak = atrOK and sessionOK and rsiShortOK and not na(rangeLow)  and shortCross and volSpike

// Gestión de trades
var int entryBarIndex = na

if validLongBreak and strategy.position_size <= 0
    stopPrice  = close - atrMultSL * atrVal
    limitPrice = close + atrMultTP * atrVal
    strategy.entry("LONG", strategy.long, comment="VOL_LONG")
    strategy.exit("LONG_EXIT", from_entry="LONG", stop=stopPrice, limit=limitPrice)
    entryBarIndex := bar_index

if validShortBreak and strategy.position_size >= 0
    stopPrice  = close + atrMultSL * atrVal
    limitPrice = close - atrMultTP * atrVal
    strategy.entry("SHORT", strategy.short, comment="VOL_SHORT")
    strategy.exit("SHORT_EXIT", from_entry="SHORT", stop=stopPrice, limit=limitPrice)
    entryBarIndex := bar_index

if timeStopBars > 0 and strategy.position_size != 0 and not na(entryBarIndex)
    if bar_index - entryBarIndex >= timeStopBars
        strategy.close(strategy.position_size > 0 ? "LONG" : "SHORT", comment="TIME_STOP")
        entryBarIndex := na

if strategy.position_size == 0
    entryBarIndex := na

// Visual
plot(rangeHigh, "Range High", color=color.new(color.yellow, 60))
plot(rangeLow, "Range Low", color=color.new(color.yellow, 60))
plot(longTrig, "Trigger Long", color=color.new(color.green, 40), style=plot.style_line)
plot(shortTrig, "Trigger Short", color=color.new(color.red, 40), style=plot.style_line)

plotshape(validLongBreak, title="Long Entry", style=shape.triangleup, color=color.new(color.green, 0), location=location.belowbar, size=size.tiny)
plotshape(validShortBreak, title="Short Entry", style=shape.triangledown, color=color.new(color.red, 0), location=location.abovebar, size=size.tiny)

// Panel de estadísticas
var float grossProfit = 0.0
var float grossLoss   = 0.0
var int   wins        = 0
var int   losses      = 0
var int   totalTrades = 0

if strategy.closedtrades > totalTrades
    tradeProfit = strategy.closedtrades.profit(strategy.closedtrades - 1)
    totalTrades += 1
    if tradeProfit > 0
        grossProfit += tradeProfit
        wins += 1
    else
        grossLoss += tradeProfit
        losses += 1

winrate      = totalTrades > 0 ? float(wins) / float(totalTrades) * 100 : na
profitFactor = grossLoss < 0 ? grossProfit / math.abs(grossLoss) : na
netProfit    = grossProfit + grossLoss
netProfitPct = strategy.initial_capital != 0 ? netProfit / strategy.initial_capital * 100 : na

var bool tableInitialized = false
var table statsTable = na
if barstate.islast and not tableInitialized
    statsTable := table.new(
         position.bottom_left,
         2,
         7,
         frame_color=color.new(color.white, 60),
         border_width=1,
         bgcolor=color.new(color.black, 75))
    tableInitialized := true

if barstate.islast and tableInitialized
    table.cell(statsTable, 0, 0, "Total trades", text_color=color.white)
    table.cell(statsTable, 1, 0, str.tostring(totalTrades))
    table.cell(statsTable, 0, 1, "Wins", text_color=color.white)
    table.cell(statsTable, 1, 1, str.tostring(wins))
    table.cell(statsTable, 0, 2, "Losses", text_color=color.white)
    table.cell(statsTable, 1, 2, str.tostring(losses))
    table.cell(statsTable, 0, 3, "Winrate %", text_color=color.white)
    table.cell(statsTable, 1, 3, str.tostring(winrate, "#.0"))
    table.cell(statsTable, 0, 4, "Profit factor", text_color=color.white)
    table.cell(statsTable, 1, 4, str.tostring(profitFactor, "#.2"))
    table.cell(statsTable, 0, 5, "Net profit %", text_color=color.white)
    table.cell(statsTable, 1, 5, str.tostring(netProfitPct, "#.2"))
    table.cell(statsTable, 0, 6, "Gross P / L", text_color=color.white)
    table.cell(statsTable, 1, 6, str.tostring(grossProfit, "#.2") + " / " + str.tostring(grossLoss, "#.2"))
